<!DOCTYPE html>
<!-- Step 73: Remove Conversion Sensitivity control and Leasing Pacing tile; trim unused funnel/boxscore CSS. -->
<!--
  Step 67: Auto-update Charts on upload+map. Charts refresh from normalized rent roll without requiring a pricing run.
-->
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Revenue Management</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#0f172a; --panel:#111827; --card:#1f2937; --muted:#94a3b8; --text:#f8fafc;
    --accent:#22d3ee; --ok:#10b981; --warn:#f59e0b; --danger:#ef4444; --ring:#38bdf8;
    --radius:14px;
  }
  *{box-sizing:border-box}
  html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font:16px/1.4 "Inter", system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial}
  .wrap{max-width:980px;margin:0 auto;padding:16px}
  h1{font-size:22px;margin:8px 0 12px}
  h2{font-size:16px;margin:0 0 10px;color:#cbd5e1;font-weight:600;letter-spacing:.02em}
  h3{font-size:15px;margin:0 0 8px;color:#cbd5e1}
  .panel{background:var(--panel);border:1px solid #0b1326;border-radius:var(--radius);padding:14px;box-shadow:0 10px 40px rgba(0,0,0,.45)}
  .grid{display:grid;grid-template-columns:1.1fr .9fr;gap:14px}
  @media (max-width:1080px){.grid{grid-template-columns:1fr}}
  .card{background:var(--card);border:1px solid #0b1220;border-radius:12px;padding:12px;margin-bottom:10px}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .row-3{display:grid;grid-template-columns:repeat(3, 1fr);gap:10px}
  .row-4{display:grid;grid-template-columns:repeat(4, 1fr);gap:10px}
  label{display:flex;align-items:center;gap:8px;font-size:12px;color:var(--muted);margin:0 0 6px}
  .help{display:inline-flex;align-items:center;justify-content:center;width:16px;height:16px;border-radius:999px;background:#0b1220;color:#a5b4fc;font-size:11px;cursor:help}
  input[type="number"], input[type="text"], select{
    width:100%;padding:10px 12px;border-radius:10px;border:1px solid #1e293b;background:#0b1220;color:var(--text);
    outline:none;transition:border-color .15s, box-shadow .15s;
  }
  input[type="number"]:focus, input[type="text"]:focus, select:focus{border-color:var(--ring);box-shadow:0 0 0 3px rgba(56,189,248,.15)}
  .switch{display:inline-flex;align-items:center;gap:10px;cursor:pointer;user-select:none}
  .switch input{display:none}
  .toggle{width:48px;height:28px;background:#0b1220;border:1px solid #1e293b;border-radius:999px;position:relative;transition:background .2s,border-color .2s}
  .knob{position:absolute;top:50%;transform:translateY(-50%);left:4px;width:20px;height:20px;background:#e2e8f0;border-radius:50%;transition:left .2s;background-image:linear-gradient(to bottom,#fff,#cbd5e1)}
  .switch input:checked + .toggle{background:var(--ok);border-color:#065f46}
  .switch input:checked + .toggle .knob{left:24px}
  .btn{appearance:none;border:1px solid #1e293b;background:#0b1220;color:var(--text);padding:8px 12px;border-radius:10px;cursor:pointer}
  .btn.primary{background:var(--accent);border-color:#0ea5a6;color:#031b21;font-weight:600}
  .btn.warn{background:#ef4444;border-color:#7f1d1d}
  .note{font-size:12px;color:var(--muted);margin-top:6px}
  table.basic{width:100%;border-collapse:collapse;font-size:13px}
  table.basic th, table.basic td{padding:6px;border-top:1px solid #0b2035;text-align:left}
  .badge{display:inline-block;padding:2px 6px;border-radius:9999px;background:#0b1220;color:#cbd5e1;font-size:11px;margin-right:6px;margin-top:4px}
  .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;background:#0b1220;border:1px solid #1e293b;color:#cbd5e1;font-size:12px}
  pre{white-space:pre-wrap;background:#08111d;border:1px solid #0b1322;border-radius:12px;padding:12px;overflow:auto;max-height:60vh}
  .iwrap{position:relative;display:inline-block}
  .itip{position:absolute;display:none;left:20px;top:-6px;min-width:220px;background:#0b1220;border:1px solid #1e293b;color:#cbd5e1;font-size:12px;padding:8px;border-radius:8px;z-index:20}
  .iwrap:hover .itip{display:block}
  .actions{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  /* Safe-minimal: soft-hide utility */
  .hidden-soft{ display:none !important; }
</style>
<script>
// Safe-minimal: stubs to prevent errors if referenced
window.applyFunnelAdjustments = window.applyFunnelAdjustments || function(x){ return x; };
window.applyConversionAdjust  = window.applyConversionAdjust  || function(x){ return x; };
// Neutral getter for conversion sensitivity to preserve Step 70 behavior
window.getConvSensitivity = window.getConvSensitivity || function(){ return 'medium'; };
</script>
<style>
/* Step 73: removed funnel lever preview styles */
</style>
<style>
/* Minimal readability tweak for month inputs (no size/layout changes) */
.months-grid input.month-input{
  text-align:center;
  font-weight:600;
  color:#e5e7eb !important;
  -webkit-text-fill-color:#e5e7eb; /* Safari */
}
</style>

<style>
.btn.sm{ font-size:12px; padding:6px 10px; border:1px solid #334155; border-radius:8px; background:#0f172a; color:#e5e7eb; }
.btn.sm:hover{ border-color:#475569; }
.btn.xs{ font-size:11px; padding:4px 8px; border:1px solid #334155; border-radius:6px; background:#0f172a; color:#e5e7eb; }
.btn.xs:hover{ border-color:#475569; }
</style>


<style>
  .health-chip{ display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; font-size:12px; border:1px solid #1e293b; background:#0b1220; }
  .health-ok{ color:#10b981; border-color:#065f46; }
  .health-watch{ color:#f59e0b; border-color:#7c4a03; }
  .health-risk{ color:#ef4444; border-color:#7f1d1d; }
  #boxScoreTable tbody tr:nth-child(odd){ background:rgba(2,6,23,0.35); }
</style>

<!-- Sync target to hidden bandLow/bandHigh for backward compatibility -->
<script>
(function(){
  function _syncBandsFromTarget(){
    try{
      var t = parseFloat(document.getElementById('comfortTarget')?.value || '95');
      if (!isFinite(t)) t = 95;
      var low = Math.max(80, Math.min(100, t - 2));
      var high = Math.max(80, Math.min(100, t + 1));
      var lowEl = document.getElementById('comfortLow');
      var highEl = document.getElementById('comfortHigh');
      if (lowEl) lowEl.value = String(low);
      if (highEl) highEl.value = String(high);
    }catch(e){}
  }
  window._syncBandsFromTarget = _syncBandsFromTarget;
  document.addEventListener('DOMContentLoaded', function(){
    _syncBandsFromTarget();
    var tgt = document.getElementById('comfortTarget');
    if (tgt){
      tgt.addEventListener('input', _syncBandsFromTarget);
      tgt.addEventListener('change', _syncBandsFromTarget);
    }
  });
})();
</script>

<script>
(function(){
  // Step 69: Base-stage clamp helper (global)
  window.clampBaseToFPCaps = function(base, fpCode){
    try{
      const setup = window.propertySetup || {};
      const fps = setup.floorplans || [];
      const fp = fps.find(x => String(x.code||'') === String(fpCode||''));
      if (!fp) return base;
      const lo = (fp.price_floor_dollars === '' || fp.price_floor_dollars == null) ? -Infinity : Number(fp.price_floor_dollars);
      const hi = (fp.price_ceiling_dollars === '' || fp.price_ceiling_dollars == null) ?  Infinity : Number(fp.price_ceiling_dollars);
      let clamped = base;
      if (Number.isFinite(lo)) clamped = Math.max(clamped, lo);
      if (Number.isFinite(hi)) clamped = Math.min(clamped, hi);
      return clamped;
    }catch(e){ return base; }
  };
  // Step 58: Lock Mode (local-only) — Draft vs Published (read-only structural)
  function $(id){ return document.getElementById(id); }
  function lockKey(){ const ps=window.propertySetup||{}; const pid=ps.property_id||ps.property_name||'default'; return `rm:lockMode:${pid}`; }
  function getLockMode(){ try{ return localStorage.getItem(lockKey())||'draft'; }catch(e){ return 'draft'; } }
  function setLockMode(v){ try{ localStorage.setItem(lockKey(), String(v||'draft')); }catch(e){} }

  function renderLockSwitch(){
    const mode = getLockMode();
    const d = $('btnModeDraft'), p=$('btnModePublished'), chip=$('lockModeChip');
    if (d) d.classList.toggle('primary', mode==='draft');
    if (p) p.classList.toggle('primary', mode==='published');
    if (chip) chip.textContent = 'Mode: ' + (mode==='published'?'Published':'Draft');
  }

  function applyLockState(){
    const mode = getLockMode(); const pub = (mode==='published');
    function setRO(qs){ document.querySelectorAll(qs).forEach(el=>{ if(pub){ el.setAttribute('disabled','disabled'); el.setAttribute('readonly','readonly'); el.classList.add('readonly'); } else { el.removeAttribute('disabled'); el.removeAttribute('readonly'); el.classList.remove('readonly'); } }); }
    // Structural fields in FP Settings
    setRO('#fpSettingsCard [data-fp-field="code"],#fpSettingsCard [data-fp-field="name"],#fpSettingsCard [data-fp-field="units"],#fpSettingsCard [data-fp-field="refask"]');
    // Add/Delete controls
    (function(){ const add=$('addFPBtn'); if(add){ if(pub){ add.setAttribute('disabled','disabled'); add.classList.add('readonly'); } else { add.removeAttribute('disabled'); add.classList.remove('readonly'); } }})();
    document.querySelectorAll('#fpSettingsCard [data-action="del"]').forEach(btn=>{ if(pub){ btn.setAttribute('disabled','disabled'); btn.classList.add('readonly'); } else { btn.removeAttribute('disabled'); btn.classList.remove('readonly'); }});
    // Floorplan Map: selects and Save/Clear disabled in Published
    document.querySelectorAll('#fpMapTableBody select').forEach(sel=>{ if(pub){ sel.setAttribute('disabled','disabled'); sel.classList.add('readonly'); } else { sel.removeAttribute('disabled'); sel.classList.remove('readonly'); } });
    const mSave=$('fpMapSaveBtn'), mClr=$('fpMapClearBtn');
    [mSave,mClr,$('fpMapSave'),$('fpMapClear')].forEach(b=>{ if(!b) return; if(pub){ b.setAttribute('disabled','disabled'); b.classList.add('readonly'); } else { b.removeAttribute('disabled'); b.classList.remove('readonly'); } });
  }

  function wireLock(){
    const d=$('btnModeDraft'), p=$('btnModePublished');
    if (d) d.addEventListener('click', ()=>{ setLockMode('draft'); renderLockSwitch(); applyLockState(); });
    if (p) p.addEventListener('click', ()=>{ setLockMode('published'); renderLockSwitch(); applyLockState(); });
    renderLockSwitch(); applyLockState();
  }

  // Expose for renderers
  window.__applyLockState = applyLockState; window.__renderLockSwitch = renderLockSwitch;
  document.addEventListener('DOMContentLoaded', wireLock);
})();
</script>

<script>
(function(){
  // Step 59R: Autocapture labels (unified candidates key)
  function uniqueLabels(rows){ const s = new Set(); (rows||[]).forEach(r=>{ const v = String(r.Floorplan||'').trim(); if (v) s.add(v); }); return Array.from(s); }
  function fpMapCandidatesKey(){ const ps=(window.propertySetup||{}); const pid=ps.property_id||ps.property_name||'default'; return `rm:fpmap:candidates:${pid}`; }
  function loadFPCandidates(){ try{ const raw=localStorage.getItem(fpMapCandidatesKey()); return raw? JSON.parse(raw): []; }catch(e){ return []; } }
  function saveFPCandidates(list){ try{ localStorage.setItem(fpMapCandidatesKey(), JSON.stringify(list||[])); }catch(e){} }

  const cm = document.getElementById('confirmMapping');
  if (cm) cm.addEventListener('click', ()=> setTimeout(capture, 60));

  let lastSig = '';
  const iv = setInterval(() => {
    const rows = Array.isArray(window.mappedRows) ? window.mappedRows : null;
    if (!rows || rows.length === 0) return;
    const sig = rows.length + ':' + Object.keys(rows[0]||{}).join(',');
    if (sig === lastSig) return;
    lastSig = sig;
    capture();
  }, 400);

  function capture(){
    try{
      const rows = Array.isArray(window.mappedRows) ? window.mappedRows : [];
      const labels = uniqueLabels(rows);
      if (labels.length){
        saveFPCandidates(labels);
        if (typeof renderFPMapCard === 'function') renderFPMapCard();
      }
    }catch(e){}
  }
})();
</script>

<script>
// Step 59R: Floorplan Map — options from Settings, unified candidates, session-gated render
(function(){
  function $(id){ return document.getElementById(id); }
  // Storage keys (canonical names)
  function fpMapStorageKey(){ const ps=window.propertySetup||{}; const pid=ps.property_id||ps.property_name||'default'; return `rm:fpmap:${pid}`; }
  function fpMapCandidatesKey(){ const ps=window.propertySetup||{}; const pid=ps.property_id||ps.property_name||'default'; return `rm:fpmap:candidates:${pid}`; }
  function loadFPMap(){ try{ return JSON.parse(localStorage.getItem(fpMapStorageKey())) || {}; }catch(e){ return {}; } }
  function saveFPMap(map){ try{ localStorage.setItem(fpMapStorageKey(), JSON.stringify(map||{})); }catch(e){} }
  function clearFPMap(){ try{ localStorage.removeItem(fpMapStorageKey()); }catch(e){} }
  function loadFPCandidates(){ try{ return JSON.parse(localStorage.getItem(fpMapCandidatesKey())) || []; }catch(e){ return []; } }
  function saveFPCandidates(labels){ try{ localStorage.setItem(fpMapCandidatesKey(), JSON.stringify(labels||[])); }catch(e){} }
  function clearFPCandidates(){ try{ localStorage.removeItem(fpMapCandidatesKey()); }catch(e){} }
  function getFPNameByCode(code){ try{ const list=(window.propertySetup&&window.propertySetup.floorplans)||[]; const fp=list.find(x=>String(x.code||'')===String(code||'')); return fp? (fp.name||'') : ''; }catch(e){ return ''; } }
  function getCodes(){ try{ return ((window.propertySetup&&window.propertySetup.floorplans)||[]).map(fp=>String(fp.code||'').trim()).filter(Boolean); }catch(e){ return []; } }

  // Session upload flag
  const SS_FLAG = 'rm:session:hasUpload';
  function setHasUpload(){ try{ sessionStorage.setItem(SS_FLAG,'1'); }catch(e){} }
  function hasUpload(){ try{ return sessionStorage.getItem(SS_FLAG)==='1'; }catch(e){ return false; } }
  window.setHasUpload = setHasUpload; window.hasUpload = hasUpload;

  // Capture labels from latest upload (mappedRows), suggest defaults, and refresh card
  function captureFPLabelsFromUpload(){
    try{
      const rows = window.mappedRows || [];
      const labels = Array.from(new Set(rows.map(r=> String(r.Floorplan||'').trim()).filter(Boolean))).sort();
      saveFPCandidates(labels);
      autoMapFromSettings();
      if (typeof renderFPMapCard==='function') renderFPMapCard();
    }catch(e){}
  }

  // Auto-map based on Settings codes (exact or first-token)
  function autoMapFromSettings(){
    try{
      const labels = loadFPCandidates();
      if (!labels || !labels.length) return;
      const codes = getCodes(); if (!codes.length) return;
      const codeLC = codes.map(c=>String(c).toLowerCase());
      const map = loadFPMap(); let changed=false;
      const firstTok = s=> (String(s||'').replace(/[×✕✖]/g,'x').trim().split(/\s+/)[0]||'').toLowerCase();
      labels.forEach(lbl=>{
        if (map[lbl]) return;
        const n = String(lbl||'').trim().toLowerCase();
        const t = firstTok(lbl);
        const idxExact = codeLC.indexOf(n);
        const idxTok = codeLC.indexOf(t);
        if (idxExact>=0) { map[lbl]=codes[idxExact]; changed=true; }
        else if (idxTok>=0) { map[lbl]=codes[idxTok]; changed=true; }
      });
      if (changed){ saveFPMap(map); const chip=document.getElementById('fpMapSavedChip'); if (chip) chip.textContent='Saved locally ' + new Date().toLocaleTimeString(); if (typeof renderFPMapCard==='function') renderFPMapCard(); }
    }catch(e){}
  }
  window.autoMapFromSettings = autoMapFromSettings;

  // Render mapping card using candidates; hide if no upload this session
  window.renderFPMapCard = function renderFPMapCard(){
    const tbody = $('fpMapTableBody'); const empty = $('fpMapEmptyAlt');
    if (!tbody || !empty) return;
    const labels = loadFPCandidates(); const map = loadFPMap(); const codes = getCodes();
    tbody.innerHTML = '';
    if (!hasUpload() || !labels.length){ empty.textContent='No rent roll uploaded yet.'; empty.style.display='block'; return; }
    empty.style.display='none';
    labels.forEach(lbl=>{
      const tr=document.createElement('tr');
      const tdL=document.createElement('td'); tdL.textContent=lbl; tr.appendChild(tdL);
      const tdS=document.createElement('td');
      const sel=document.createElement('select'); sel.setAttribute('aria-label', `Map ${lbl} to code`);
      const opt0=document.createElement('option'); opt0.value=''; opt0.textContent='(Select code)'; sel.appendChild(opt0);
      codes.forEach(c=>{ const o=document.createElement('option'); o.value=c; o.textContent=c; sel.appendChild(o); });
      sel.value = map[lbl] || '';
      sel.addEventListener('change', ()=>{ const m=loadFPMap(); if(sel.value) m[lbl]=sel.value; else delete m[lbl]; saveFPMap(m); renderFPMapCard(); const chip=$('fpMapSavedChip'); if(chip) chip.textContent='Saved locally ' + new Date().toLocaleTimeString(); });
      tdS.appendChild(sel); tr.appendChild(tdS);
      const tdP=document.createElement('td'); const code=map[lbl]||''; const name= code? getFPNameByCode(code):''; tdP.textContent = code? (name? `${code} — ${name}` : code) : '—'; tr.appendChild(tdP);
      tbody.appendChild(tr);
    });
    try{ if (typeof window.__applyLockState==='function') window.__applyLockState(); }catch(e){}
  };

  function bindFPMapButtons(){
    const save=$('fpMapSaveBtn'); const clr=$('fpMapClearBtn'); const clrLegacy=$('fpMapClear');
    if (save) save.addEventListener('click', ()=>{ const chip=$('fpMapSavedChip'); if (chip) chip.textContent='Saved locally ' + new Date().toLocaleTimeString(); });
    const doClear = ()=>{ if (!confirm('Clear all label→code mappings for this property?')) return; clearFPMap(); clearFPCandidates(); renderFPMapCard(); const chip=$('fpMapSavedChip'); if (chip) chip.textContent='Cleared'; };
    if (clr) clr.addEventListener('click', doClear);
    if (clrLegacy) clrLegacy.addEventListener('click', doClear);
  }

  // Wire on load and on mapping confirm
  document.addEventListener('DOMContentLoaded', ()=>{ try{ renderFPMapCard(); bindFPMapButtons(); }catch(e){} });
  const cm=document.getElementById('confirmMapping'); if (cm){ cm.addEventListener('click', ()=> setTimeout(()=>{ try{ if (typeof setHasUpload==='function') setHasUpload(); captureFPLabelsFromUpload(); }catch(e){} }, 60)); }
})();
</script>

<script>
// Step 56: Floorplan CODE mapping + normalization and New Pricing override
(function(){
  function $(id){ return document.getElementById(id); }
  const MAP_NS = 'rm:fpmap:';
  function getFPMapKey(){ const ps=(window.propertySetup||{}); return MAP_NS + (ps.property_id || ps.property_name || 'default'); }
  function getAllCodes(){ try{ return (window.propertySetup.floorplans||[]).map(f=>String(f.code||'')).filter(Boolean);}catch(e){return [];} }
  function loadFPMap(){ try{ const raw=localStorage.getItem(getFPMapKey()); return raw? JSON.parse(raw) : {}; }catch(e){ return {}; } }
  function saveFPMap(map){ try{ localStorage.setItem(getFPMapKey(), JSON.stringify(map||{})); }catch(e){} }
  function clearFPMap(){ try{ localStorage.removeItem(getFPMapKey()); }catch(e){} }
  function uniqueLabels(rows){ const s=new Set(); (rows||[]).forEach(r=>{ const v=String(r.Floorplan||'').trim(); if(v) s.add(v); }); return Array.from(s); }
  function applyFPMapToRows(rows, map, codes){ const out=[]; const unm=new Set(); const set=new Set(codes||[]); (rows||[]).forEach(r=>{ const lbl=String(r.Floorplan||'').trim(); let code = map && map[lbl]; if(!code && set.has(lbl)) code=lbl; if(code) out.push(Object.assign({}, r, { FP_CODE: code, FloorplanLabel: lbl })); else { unm.add(lbl); out.push(Object.assign({}, r, { FloorplanLabel: lbl })); } }); return { rows: out, unmapped: unm }; }

  function renderFPMapCard(){
    /* Legacy renderer (fpMapWrap/fpMapEmpty). Disabled in Step 57 in favor of table-based renderer. */
  }

  function normalizeRentRoll(){
    const rows = Array.isArray(window.mappedRows) ? window.mappedRows : [];
    const map = loadFPMap(); const codes = getAllCodes();
    const res = applyFPMapToRows(rows, map, codes);
    window.normRows = res.rows; window.unmappedLabels = Array.from(res.unmapped||[]);
    try{
      // Step 67: Auto-refresh charts from rent roll if mapping is valid
      if (Array.isArray(window.normRows) && window.normRows.length){
        if (typeof window.refreshChartsFromRentRoll==='function') window.refreshChartsFromRentRoll();
        const unm = window.unmappedLabels||[];
        if (typeof window.hasUpload==='function' && window.hasUpload() && unm.length===0){
          if (typeof setTabDisabled==='function') setTabDisabled('charts', false);
        }
      }
    }catch(e){}
  }

  document.addEventListener('DOMContentLoaded', ()=>{ try{ renderFPMapCard(); }catch(e){} try{ normalizeRentRoll(); }catch(e){} });
  const cm = document.getElementById('confirmMapping'); if (cm) cm.addEventListener('click', ()=> setTimeout(()=>{ try{ if (typeof setHasUpload==='function') setHasUpload(); renderFPMapCard(); normalizeRentRoll(); if (typeof window.refreshChartsFromRentRoll==='function') window.refreshChartsFromRentRoll(); }catch(e){} }, 60));

  // Guard New run if unmapped
  if (typeof window.canRun === 'function'){
    const _old = window.canRun;
    window.canRun = function(){ const ok=_old(); if(!ok) return false; try{ normalizeRentRoll(); }catch(e){} const unm = window.unmappedLabels||[]; if (unm.length){ const nl=$('nlTables'); if(nl){ nl.innerHTML = `<div class=\"note\" style=\"border:1px solid #7f1d1d;background:#1b0f12;color:#fca5a5;padding:8px;border-radius:8px;\">Unmapped floorplan labels: ${unm.slice(0,12).join(', ')}. <a href=\"#\" id=\"goMap\">Map them on Settings → Floorplan Map</a>.</div>`; setTimeout(()=>{ const a=$('goMap'); if (a) a.onclick=(e)=>{ e.preventDefault(); if (typeof setTab==='function') setTab('settings'); const card=$('fpMapCard'); if(card) card.scrollIntoView({behavior:'smooth'}); }; },0);} return false; } return true; };
  }

  // Normalize New Pricing to use FP_CODE grouping while preserving UI
  if (typeof window.renderNewLease === 'function'){
    const _origRender = window.renderNewLease;
    window.renderNewLease = function(cfg, norm, tState){
      const rows = (Array.isArray(window.normRows) && window.normRows.some(r=>r.FP_CODE))
        ? window.normRows.map(r=> Object.assign({}, r, { Floorplan: r.FP_CODE }))
        : (norm||[]);
      _origRender(cfg, rows, tState);
      // Add normalization footnote
      const wrap = $('nlTables'); if (wrap){ wrap.insertAdjacentHTML('afterbegin', '<div class="note">Floorplans normalized to codes; CSV labels shown for reference only.</div>'); }
    };
  }
})();
</script>

<script>
(function(){
  // Step 52: Floorplan Settings manual editor (Settings tab)
  function $(id){ return document.getElementById(id); }
  function clamp(x, lo, hi){ return Math.min(Math.max(x, lo), hi); }
  function toInt(v, d=0){ const n=Number(v); return Number.isFinite(n)? Math.round(n): d; }
  // Note: clampBaseToFPCaps is defined globally for reuse across modules.
  function normalizeCode(s){ return String(s||'').trim().replace(/\s+/g,' '); }
  const LS_KEY = 'rm:propertySetup:floorplans';

  // Initialize state
  window.propertySetup = window.propertySetup || {
    community_settings: { target_occupancy_pct: 95 },
    floorplans: []
  };

  // Helpers: compute duplicate codes map
  function dupMap(rows){ const m=new Map(); for(const r of rows){ const c=normalizeCode(r.code); if(!c) continue; m.set(c,(m.get(c)||0)+1);} return m; }
  function bandIssues(low, high){
    const out = { lowGtHigh:false, outOfRange:false };
    const l=Number(low), h=Number(high);
    if (Number.isFinite(l) && Number.isFinite(h) && l>h) out.lowGtHigh=true;
    if ((l && (l<70 || l>100)) || (h && (h<70 || h>100))) out.outOfRange = true;
    return out;
  }

  // Validity checks for saving
  function isRowValid(r){
    if (!String(r.code||'').trim()) return false;
    if (!String(r.name||'').trim()) return false;
    const l = Number(r.band_low_pct), h = Number(r.band_high_pct);
    if (!Number.isFinite(l) || !Number.isFinite(h)) return false;
    if (l<70 || l>100 || h<70 || h>100) return false;
    if (l>h) return false;
    if (Number(r.units)<0) return false;
    if (Number(r.stop_down_buffer_dollars)<0) return false;
    if (Number(r.gap_to_next_tier_dollars)<0) return false;
    if (Number(r.reference_ask)<0) return false;
    if (r.price_floor_dollars!=null && String(r.price_floor_dollars)!=='' && Number(r.price_floor_dollars)<0) return false;
    if (r.price_ceiling_dollars!=null && String(r.price_ceiling_dollars)!=='' && Number(r.price_ceiling_dollars)<0) return false;
    return true;
  }
  function isTableValid(){
    const rows = window.propertySetup.floorplans || [];
    const dups = dupMap(rows);
    for(const r of rows){ if (String(r.code||'') && dups.get(normalizeCode(r.code))>1) return false; }
    return rows.every(isRowValid);
  }

  function updateSavedChip(text){
    const chip = document.getElementById('fpSavedChip');
    if (!chip) return;
    if (text){ chip.textContent = text; chip.style.display='inline-block'; }
    else { chip.textContent=''; chip.style.display='none'; }
  }

  function saveFPsLocal(){
    try{
      const rows = window.propertySetup.floorplans || [];
      localStorage.setItem(LS_KEY, JSON.stringify(rows));
      const t = new Date().toLocaleTimeString();
      updateSavedChip('Saved locally ' + t);
    }catch(e){ /* ignore */ }
  }
  function maybeSaveLocal(){ if (isTableValid()) saveFPsLocal(); }
  function loadFPsLocal(){
    try{
      const rows = window.propertySetup.floorplans || [];
      if (rows.length) return;
      const raw = localStorage.getItem(LS_KEY);
      if (!raw) return;
      const parsed = JSON.parse(raw);
      if (Array.isArray(parsed)) { window.propertySetup.floorplans = parsed; }
    }catch(e){ /* ignore */ }
  }

  // Render table body from state
  function renderFPTable(){
    const tbody = $('fpTableBody'); if(!tbody) return;
    const rows = window.propertySetup.floorplans || [];
    const dups = dupMap(rows);
    const esc = s=>String(s??'').replace(/&/g,'&amp;').replace(/</g,'&lt;');
    // derive bedroom tiers once to disable gap field on lowest tier
    function _bedOf(code,name){
      const c=String(code||''); const s=(String(code||'')+' '+String(name||'')).toLowerCase();
      if (/\b(s0|studio|0x1)\b/i.test(c) || /\b(studio|0x1)\b/.test(String(name||'').toLowerCase())) return 0;
      if (/\b1x1\b/i.test(s) || /\b1\s*br\b/i.test(s)) return 1;
      if (/\b2x2\b/i.test(s) || /\b2\s*br\b/i.test(s)) return 2;
      if (/\b3x\d\b/i.test(s) || /\b3\s*br\b/i.test(s)) return 3;
      if (/\b4x\d\b/i.test(s) || /\b4\s*br\b/i.test(s)) return 4;
      if (/^a/i.test(c)) return 1; if (/^b/i.test(c)) return 2; if (/^c/i.test(c)) return 3;
      const m1=s.match(/(\d)\s*br/); if(m1) return parseInt(m1[1]); const m2=s.match(/(\d)\s*x\s*(\d)/); if(m2) return parseInt(m2[1]);
      return 1;
    }
    const minTier = rows.length ? Math.min(...rows.map(r=>_bedOf(r.code,r.name))) : 0;
    const maxTier = rows.length ? Math.max(...rows.map(r=>_bedOf(r.code,r.name))) : 0;

    tbody.innerHTML = rows.map((r,idx)=>{
      const code = normalizeCode(r.code);
      const issues = bandIssues(r.band_low_pct, r.band_high_pct);
      const badges = [];
      if (code && dups.get(code)>1) badges.push('<span class="badge danger">Duplicate code</span>');
      if (issues.lowGtHigh) badges.push('<span class="badge danger">Low > High</span>');
      if (issues.outOfRange) badges.push('<span class="badge warn">Outside range</span>');
      const reqClass = (v)=> (String(v||'').trim()? '' : 'invalid');
      return `<tr data-row="${idx}">
        <td style="color:#94a3b8">⋮⋮</td>
        <td>
          ${badges.join(' ')}
          <input type="text" maxlength="12" value="${esc(r.code)}" aria-label="Code" class="${reqClass(r.code)}" data-k="code" data-i="${idx}" data-fp-field="code" style="width:120px" />
        </td>
        <td>
          <input type="text" maxlength="40" value="${esc(r.name)}" aria-label="Name" class="${reqClass(r.name)}" data-k="name" data-i="${idx}" data-fp-field="name" style="width:160px" />
        </td>
        <td>
          <input type="number" step="1" min="0" value="${toInt(r.units,0)}" aria-label="Units" data-k="units" data-i="${idx}" data-fp-field="units" style="width:90px" />
        </td>
        <td>
          <input type="number" step="0.5" min="70" max="100" value="${Number(r.band_low_pct||0)}" aria-label="Band Low %" data-k="band_low_pct" data-i="${idx}" data-fp-field="bandlow" style="width:110px" />
        </td>
        <td>
          <input type="number" step="0.5" min="70" max="100" value="${Number(r.band_high_pct||0)}" aria-label="Band High %" data-k="band_high_pct" data-i="${idx}" data-fp-field="bandhigh" style="width:110px" />
        </td>
        <td>
          <input type="number" step="1" min="0" value="${toInt(r.stop_down_buffer_dollars||0,0)}" aria-label="Buffer $ (stop-decrease)" data-k="stop_down_buffer_dollars" data-i="${idx}" data-fp-field="buffer" style="width:130px" />
        </td>
        <td>
          ${(_bedOf(r.code,r.name)===maxTier)
            ? `<input type="number" step="1" min="0" value="0" aria-label="Min Gap to Next Tier $" data-k="gap_to_next_tier_dollars" data-i="${idx}" data-fp-field="gapnew" style="width:170px" disabled readonly class="readonly" />`
            : `<input type=\"number\" step=\"1\" min=\"0\" value=\"${toInt(r.gap_to_next_tier_dollars||0,0)}\" aria-label=\"Min Gap to Next Tier $\" data-k=\"gap_to_next_tier_dollars\" data-i=\"${idx}\" data-fp-field=\"gapnew\" style=\"width:170px\" />`}
        </td>
        <td>
          <input type="number" step="1" min="0" value="${toInt(r.reference_ask||0,0)}" aria-label="Starting Rent $" data-k="reference_ask" data-i="${idx}" data-fp-field="refask" style="width:130px" />
        </td>
        <td>
          <input type="number" step="1" min="0" value="${(r.price_floor_dollars!=null&&String(r.price_floor_dollars)!=='')?toInt(r.price_floor_dollars,0):''}" aria-label="Price Floor ($)" data-k="price_floor_dollars" data-i="${idx}" data-fp-field="pfloor" style="width:120px" />
        </td>
        <td>
          <input type="number" step="1" min="0" value="${(r.price_ceiling_dollars!=null&&String(r.price_ceiling_dollars)!=='')?toInt(r.price_ceiling_dollars,0):''}" aria-label="Price Ceiling ($)" data-k="price_ceiling_dollars" data-i="${idx}" data-fp-field="pceil" style="width:120px" />
        </td>
        <td>
          <button class="btn xs" data-action="del" data-i="${idx}" aria-label="Delete row">🗑️</button>
        </td>
      </tr>`;
    }).join('');

    // Wire inputs
    tbody.querySelectorAll('input').forEach(inp=>{
      inp.addEventListener('input', onInputValidate);
      inp.addEventListener('change', onCommit);
      inp.addEventListener('blur', onCommit);
    });
    tbody.querySelectorAll('[data-action="del"]').forEach(btn=>{
      btn.addEventListener('click', (e)=>{ e.preventDefault(); deleteFPRow(Number(btn.dataset.i)); });
    });
    try{ if (typeof window.__applyLockState==='function') window.__applyLockState(); }catch(e){}
  }

  function onInputValidate(e){
    const inp = e.target; const key = inp.dataset.k;
    if (inp.type==='text'){
      const v = String(inp.value||'').trim();
      inp.classList.toggle('invalid', v.length===0);
    } else if (inp.type==='number'){
      const v = inp.value;
      const isNum = v!=='' && !isNaN(Number(v));
      inp.classList.toggle('invalid', !isNum);
      if (isNum && (key==='band_low_pct' || key==='band_high_pct')){
        const n = Number(v);
        inp.classList.toggle('warn', n<70 || n>100);
      } else {
        inp.classList.remove('warn');
      }
    }
  }

  function onCommit(e){
    const inp = e.target; const idx = Number(inp.dataset.i); const key = inp.dataset.k;
    if (!key || Number.isNaN(idx)) return;
    let val = inp.type==='number' ? Number(inp.value) : inp.value;
    setFP(idx, key, val);
  }

  function addFPRow(){
    const rows = window.propertySetup.floorplans || (window.propertySetup.floorplans=[]);
    rows.push({ code:"", name:"", units:0, band_low_pct:93, band_high_pct:96, stop_down_buffer_dollars:0, gap_to_next_tier_dollars:0, reference_ask:0, price_floor_dollars:'', price_ceiling_dollars:'' });
    renderFPTable();
    maybeSaveLocal();
  }

  function deleteFPRow(idx){
    const rows = window.propertySetup.floorplans || [];
    if (idx>=0 && idx<rows.length){ rows.splice(idx,1); renderFPTable(); }
    maybeSaveLocal();
  }

  function setFP(idx, key, value){
    const rows = window.propertySetup.floorplans || [];
    if (!rows[idx]) return;
    if (key==='code') value = normalizeCode(value).slice(0,12);
    if (key==='name') value = String(value||'').slice(0,40);
    if (key==='units' || key==='stop_down_buffer_dollars' || key==='reference_ask' || key==='gap_to_next_tier_dollars' || key==='price_floor_dollars' || key==='price_ceiling_dollars'){
      if (String(value)===''){ rows[idx][key] = ''; renderFPTable(); return; }
      value = Math.max(0, toInt(value,0));
    }
    if (key==='band_low_pct' || key==='band_high_pct') value = clamp(Math.round(Number(value||0)*2)/2, 70, 100);
    rows[idx][key] = value;
    // Only re-render table (badges/validation). No other side effects.
    renderFPTable();
    maybeSaveLocal();
  }

  // Prefill from mapped rent roll if present
  function normalizeLabel(s){ return String(s||'').replace(/[×✕✖]/g,'x').trim().replace(/\s+/g,' ').toLowerCase(); }
  function firstToken(label){ const raw=String(label||'').replace(/[×✕✖]/g,'x').trim().replace(/\s+/g,' '); return (raw.split(/\s+/)[0]||'').replace(/[^A-Za-z0-9]/g,''); }
  function codeFromLabel(label){ const tok=firstToken(label); const sanitized = tok || String(label||'').replace(/[^A-Za-z0-9]/g,''); return (sanitized||'FP').slice(0,12); }
  function prefillFromRentRoll(){
    const mr = Array.isArray(window.mappedRows) ? window.mappedRows : null;
    if (!mr || !mr.length) return;
    const freq = new Map();
    for(const r of mr){ const lbl=String(r.Floorplan||'').trim(); const key=normalizeLabel(lbl); if (!key) continue; const cur=freq.get(key)||{label:lbl,units:0}; cur.units++; if(!cur.label) cur.label=lbl; freq.set(key,cur); }
    const out=[];
    for(const {label,units} of freq.values()){
      const code = codeFromLabel(label);
      const small = (units<15);
      out.push({ code, name: label, units, band_low_pct: small?92:93, band_high_pct: small?97:96, stop_down_buffer_dollars:0, gap_to_next_tier_dollars:0, reference_ask:0, price_floor_dollars:'', price_ceiling_dollars:'' });
    }
    window.propertySetup.floorplans = out;
    renderFPTable();
    saveFPsLocal();
    try{ if (typeof window.__applyLockState==='function') window.__applyLockState(); }catch(e){}
  }

  function mergeFromRentRoll(){
    const mr = Array.isArray(window.mappedRows) ? window.mappedRows : null;
    if (!mr || !mr.length) return;
    const freq = new Map();
    for(const r of mr){ const lbl=String(r.Floorplan||'').trim(); const key=normalizeLabel(lbl); if (!key) continue; const cur=freq.get(key)||{label:lbl,units:0}; cur.units++; if(!cur.label) cur.label=lbl; freq.set(key,cur); }
    const rows = window.propertySetup.floorplans || (window.propertySetup.floorplans=[]);
    const byCode = new Map(rows.map((r,i)=>[String(r.code||'').toLowerCase(), {i,r}]));
    const byName = new Map(rows.map((r,i)=>[normalizeLabel(r.name||''), {i,r}]));
    const usedCodes = new Set(rows.map(r=>String(r.code||'').toLowerCase()).filter(Boolean));
    const add=[];
    for(const {label,units} of freq.values()){
      const tok = firstToken(label).toLowerCase();
      let t = byCode.get(tok) || byName.get(normalizeLabel(label));
      if (t){ rows[t.i].units = units; }
      else {
        let c = codeFromLabel(label); let base=c.toLowerCase(); let n=1; while(usedCodes.has(base)){ n++; c=(c+n).slice(0,12); base=c.toLowerCase(); }
        usedCodes.add(base);
        const small=(units<15);
        add.push({ code:c, name:label, units, band_low_pct: small?92:93, band_high_pct: small?97:96, stop_down_buffer_dollars:0, gap_to_next_tier_dollars:0, reference_ask:0, price_floor_dollars:'', price_ceiling_dollars:'' });
      }
    }
    if (add.length) rows.push(...add);
    renderFPTable();
    saveFPsLocal();
    try{ if (typeof window.__applyLockState==='function') window.__applyLockState(); }catch(e){}
  }

  function initFPSettings(){
    const add = document.getElementById('addFPBtn'); if (add) add.addEventListener('click', addFPRow);
    const pf = document.getElementById('prefillFromRR');
    if (pf){
      if (Array.isArray(window.mappedRows) && window.mappedRows.length){ pf.style.display='inline'; pf.addEventListener('click', (e)=>{ e.preventDefault(); const rows=(window.propertySetup&&window.propertySetup.floorplans)||[]; if (!rows.length) prefillFromRentRoll(); else mergeFromRentRoll(); if (typeof window.renderFPMapCard==='function') window.renderFPMapCard(); if (typeof window.autoMapFromSettings==='function') window.autoMapFromSettings(); }); }
      else { pf.style.display = 'none'; }
    }
    // Local persistence controls
    const clear = document.getElementById('fpClearLocal');
    if (clear) clear.addEventListener('click', (e)=>{ e.preventDefault(); if (confirm('Clear locally saved data?')){ try{ localStorage.removeItem(LS_KEY);}catch(err){} try{ const ps=window.propertySetup||{}; const pid=ps.property_id||ps.property_name||'default'; localStorage.removeItem(`rm:fpmap:${pid}`); localStorage.removeItem(`rm:fpmap:candidates:${pid}`);}catch(err){} (window.propertySetup.floorplans=[]); renderFPTable(); try{ if (typeof window.renderFPMapCard==='function') window.renderFPMapCard(); }catch(err){} updateSavedChip('Cleared'); }});
    const reset = document.getElementById('fpResetDefaults');
    if (reset) reset.addEventListener('click', (e)=>{ e.preventDefault(); window.propertySetup.floorplans=[{ code:'A1', name:'1x1', units:0, band_low_pct:93, band_high_pct:96, stop_down_buffer_dollars:0, reference_ask:0, price_floor_dollars:'', price_ceiling_dollars:'' }]; renderFPTable(); saveFPsLocal(); });

    // Load any local persisted rows if current state is empty
    loadFPsLocal();
    renderFPTable();
  }

  if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', initFPSettings);
  else initFPSettings();
})();
</script>


<style>
  .tab-hidden { display: none !important; }
  #tabBar .btn.sm.active { background: var(--accent); color:#031b21; border-color:#0ea5a6; font-weight:600; }
</style>

<style>

/* === Option B: Single-column focus & legend hidden === */
.grid { display: block !important; }
.panel { padding: 20px 20px; }
.card { margin: 16px 0; padding: 16px 18px; border-radius: var(--radius); box-shadow: 0 8px 24px rgba(0,0,0,.35); }
h2 { margin-bottom: 12px; letter-spacing: .02em; }
.section-divider { height: 2px; background: linear-gradient(90deg, rgba(34,211,238,.35), transparent); margin: 24px 0; }
.sticky-summary {
  position: sticky; top: 56px; z-index: 50;
  background: rgba(15,23,42,.85);
  backdrop-filter: saturate(120%) blur(6px);
  border: 1px solid #0b1326; border-radius: 12px;
  padding: 10px 12px;
}
#legendCard { display: none !important; }

</style>
<style>

/* === Settings Tab: Compact Executive Layout === */
.settings-card { padding: 12px 14px; margin: 12px 0; }
.settings-card .row, .settings-card .row-3, .settings-card .row-4 { gap: 8px; }
.settings-card label { margin-bottom: 4px; font-size: 12px; color: var(--muted); }
.settings-card input[type="number"], 
.settings-card input[type="text"], 
.settings-card select { padding: 8px 10px; border-radius: 8px; }
.settings-card .note { margin-top: 4px; }
.settings-card h2 { margin-bottom: 10px; }

/* Strategy top row: three columns */
.strategy-row { 
  display: grid; 
  grid-template-columns: 1fr 1fr auto; 
  align-items: end; 
  gap: 12px; 
}
/* Narrower comfort inputs */

/* NL terms button compact */
#nlDropdownBtn { padding: 6px 10px !important; font-size: 12px; border-radius: 8px; }
#nlDropdownPanel { right: 0; }
/* Tighten Seasonality grid within Settings */
.settings-card .months-grid { gap: 6px; }
.settings-card .months-grid input.month-input { padding: 4px 2px; border-radius: 6px; }
/* Reduce card shadows slightly on Settings for visual calm */
.settings-card { box-shadow: 0 6px 18px rgba(0,0,0,.30); }

</style>



<style>
/* === Home CTA styling (screenshot + shade) === */
/* Default Home buttons: dark pill */
.home-only .btn,
.home-only .btn.secondary,
.home-only .btn.xs {
  background: #121a2b;
  color: #e6f6ff;
  border: 1px solid #1f2b44;
  padding: 10px 14px;
  border-radius: 12px;
  font-weight: 600;
  font-size: 13.5px;
  line-height: 1;
  box-shadow: 0 6px 18px rgba(0,0,0,.25);
  transition: filter .15s ease, transform .15s ease, box-shadow .15s ease;
}
/* Accent fill for primary "Run" (with subtle shade/gradient) */
.home-only .btn.accent {
  background: linear-gradient(180deg, var(--accent), #20cfe5);
  color: #001018;
  border: none;
  box-shadow: 0 10px 24px rgba(34,211,238,.35), inset 0 -2px 0 rgba(0,0,0,.20);
}
.home-only .btn:hover { filter: brightness(1.05); transform: translateY(-1px); }
.home-only .btn:active { transform: translateY(0); }
/* Spacing */
.home-only .btn + .btn { margin-left: 6px; }
/* Dark pills brighten on hover */
.home-only .btn:not(.accent):hover {
  box-shadow: 0 8px 22px rgba(0,0,0,.35);
  filter: brightness(1.08);
}

/* Hide in-tab run/export controls (Home is the control surface now) */
#runNew, #exportNew, #runRenew, #exportRenew { display: none !important; }

/* Disable New Pricing & Renewals tabs until runs occur */
#tabBar [data-tab="newPricing"].disabled,
#tabBar [data-tab="renewals"].disabled {
  opacity: .55;
  cursor: not-allowed;
  position: relative;
}

/* Tooltip on hover for disabled tabs */
#tabBar [data-tab].disabled:hover::after {
  content: "🔒 Run from Home to unlock";
  position: absolute;
  top: 42px;
  left: 0;
  white-space: nowrap;
  background: #0b1326;
  border: 1px solid #1f2b44;
  color: #cbd5e1;
  padding: 6px 8px;
  border-radius: 8px;
  box-shadow: 0 8px 24px rgba(0,0,0,.35);
  z-index: 100;
}

/* Tiny wiggle to indicate blocked click */
@keyframes wiggleY { 0%{transform:translateY(0)} 25%{transform:translateY(-1px)} 50%{transform:translateY(0)} 75%{transform:translateY(-1px)} 100%{transform:translateY(0)} }
#tabBar [data-tab].wiggle { animation: wiggleY .18s ease-in-out; }
</style>



  
  <style>
  /* === Home: Forward Status at a Glance (Step 45) === */
  .status45 { display:flex; flex-direction:column; gap:16px; }
  .status45 .kpi-row { display:grid; grid-template-columns: repeat(4, minmax(0, 1fr)); gap:12px; }
  .status45 .tile { border:1px solid #1e293b; border-radius:12px; padding:14px 16px; background:#0b1220; box-shadow:0 1px 2px rgba(0,0,0,.2); }
  .status45 .tile h3 { margin:0; font-size:12px; text-transform:uppercase; letter-spacing:.04em; color:#94a3b8; }
  .status45 .tile .big { font-size:28px; font-weight:700; margin:6px 0 2px; }
  .status45 .tile .sub { color:#94a3b8; font-size:12px; }
  .status45 .pill { display:inline-block; font-size:11px; padding:2px 8px; border-radius:9999px; margin-left:6px; vertical-align:middle; }
  .status45 .green { color:#10b981; background:rgba(16,185,129,.12); border:1px solid rgba(16,185,129,.35); }
  .status45 .red   { color:#ef4444; background:rgba(239,68,68,.12); border:1px solid rgba(239,68,68,.35); }
  .status45 .amber { color:#f59e0b; background:rgba(245,158,11,.12); border:1px solid rgba(245,158,11,.35); }
  .status45 .neutral { color:#e2e8f0; background:#0f172a; border:1px solid #334155; }

  .status45 .alerts-row { display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
  .status45 .alert-card { border:1px solid #1e293b; border-radius:12px; padding:12px 14px; background:#0b1220; }
  .status45 .alert-card h4 { margin:0 0 8px; font-size:13px; font-weight:600; display:flex; align-items:center; gap:8px; }
  .status45 .alert-list { margin:0; padding:0; list-style:none; display:flex; flex-direction:column; gap:6px; }
  .status45 .alert-item { display:flex; justify-content:space-between; gap:12px; font-size:13px; }
  .status45 .alert-item small { color:#94a3b8; }
  @media (max-width: 1024px) {
    .status45 .kpi-row { grid-template-columns: repeat(2, minmax(0,1fr)); }
    .status45 .alerts-row { grid-template-columns: 1fr; }
  }
  </style>

  <style>
  /* --- Step 46: Status widget polish --- */
  #status45-card { margin-top: 2px; }
  .status45 .kpi-row { gap: 14px; }
  .status45 .tile { padding: 16px 18px; border-radius: 14px; transition: transform .06s ease, box-shadow .2s ease, border-color .2s; }
  .status45 .tile:hover { transform: translateY(-1px); box-shadow: 0 6px 18px rgba(0,0,0,.28); border-color: #3b455c; }
  .status45 .tile .big { line-height: 1.1; letter-spacing: .2px; }
  .status45 .tile .sub { margin-top: 2px; opacity: .9; }
  .status45 .pill { margin-left: 8px; padding: 3px 10px; }
  .status45 .alerts-row { gap: 14px; }
  .status45 .alert-card { border-radius: 14px; }
  .status45 .alert-item { align-items: center; }
  </style>

  <style>
  /* Step 48: Funnel band pill */
  .status45 .pill-band { margin-left: 8px; }
  </style>

  <style>
  /* Step 47: Box Score uploader */
  /* Step 73: removed box score upload card input/label styles */
  </style>

</head>
<body>
<div class="wrap">
  <h1><span class="logo-emoji">🚀</span> Revenue Management</h1>
  <div id="tabBar" style="position:sticky; top:0; z-index:100; background:var(--bg); padding:8px 0; margin:0 0 8px; border-bottom:1px solid #0b1326;">
    <div class="actions" style="gap:8px; flex-wrap:wrap">
      <button class="btn sm" data-tab="home">🏠 Home</button>
      <button class="btn sm" data-tab="settings">⚙️ Settings</button>
      <button class="btn sm" data-tab="newPricing">💵 New Pricing</button>
      <button class="btn sm" data-tab="renewals">🔁 Renewals</button>
      <button class="btn sm" data-tab="charts">📊 Charts</button>
      <button class="btn sm" data-tab="history">🕒 History</button>
    </div>
  </div>

      

  <div class="grid">
    <div class="panel">


<style>
/* Home visibility harness */
.home-only{ display:none; }
body[data-active-tab="home"] .home-only{ display:block; }
/* Simple horizontal groups */
.home-actions{ display:grid; grid-template-columns:1fr 1fr; gap:12px; }
@media(max-width:900px){ .home-actions{ grid-template-columns:1fr; } }
.home-group{ background:#0f172a; border:1px solid #0b1326; border-radius: var(--radius); padding:12px; }
.home-group .title{ font-weight:600; margin-bottom:8px }
.home-group .btnrow{ display:flex; gap:8px; flex-wrap:wrap; align-items:center }
</style>




      <!-- Privacy -->
      <div class="card">
        <div class="note"><strong>Privacy:</strong> Files are parsed in your browser (no server upload). When we move to SaaS: encryption at rest & in transit, strict retention, and no third party sharing.</div>
      </div>

      <!-- Upload + Mapping -->
      

<!-- Removed Property card (Thorpe Gardens) -->
<div class="card">
        <h2 data-tab-scope="home">Upload Rent Roll</h2>
        <input id="file" type="file" accept=".csv" />
        <div id="automap" style="display:none; margin-top:12px">
          <h3>Column Mapping (auto detected — adjust if needed)</h3>
          <div id="mapTable" style="overflow:auto"></div>
          <div id="validationBox" class="note"></div>
          <button id="confirmMapping" class="btn" style="margin-top:8px">Confirm Mapping</button>
      </div>
      </div>
      <div class="home-only">
      
      <div class="card hidden-soft" data-tab-scope="home" id="boxscore-card">
        <h2 data-tab-scope="home">Upload Box Score (optional)</h2>
        <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap">
          <input type="file" id="boxscoreFile" accept=".csv" />
          <button class="btn" id="btnParseBoxScore">Parse</button>
          <span id="boxscoreMeta" style="opacity:.8">No file parsed</span>
        </div>
        <div id="boxscoreMap" style="display:none;margin-top:12px">
          <div style="display:flex;gap:12px;flex-wrap:wrap">
            <label>Date
              <select id="map_bs_date"></select>
            </label>
            <label>Leads
              <select id="map_bs_leads"></select>
            </label>
            <label>Applications
              <select id="map_bs_apps"></select>
            </label>
            <label>Approvals
              <select id="map_bs_approvals"></select>
            </label>
          </div>
          <div style="margin-top:10px;display:flex;gap:8px;align-items:center">
            <button class="btn" id="btnConfirmBoxScore">Confirm Mapping</button>
            <small style="opacity:.8">Daily rows preferred. Weekly works too.</small>
          </div>
        </div>
      </div>
  <div class="card">
    <h2 data-tab-scope="home">Run & Export</h2>
    <div class="home-actions">
      <div class="home-group">
        <div class="title">💵 New Pricing</div>
        <div class="btnrow">
          <button class="btn" id="homeRunNew" class="btn accent" class="btn accent">Run New</button>
          <button class="btn secondary sm" id="homeExportNew">Export New</button>
          <button class="btn xs" data-goto="newPricing">View</button>
        </div>
      </div>
      <div class="home-group">
        <div class="title">🔁 Renewals</div>
        <div class="btnrow">
          <button class="btn" id="homeRunRenew" class="btn accent" class="btn accent">Run Renewals</button>
          <button class="btn secondary sm" id="homeExportRenew">Export Renew</button>
          <button class="btn xs" data-goto="renewals">View</button>
        </div>
      </div>
    </div>
    <!-- Hidden fallbacks for legacy code; auto-synced from target -->
    <input id="comfortLow" type="hidden" value="93">
    <input id="comfortHigh" type="hidden" value="96">
  </div>

      <!-- Status 45: Forward-looking widget (placed under Run & Export) -->
      <div class="card" data-tab-scope="home" id="status45-card">
        <h2 data-tab-scope="home">Status at a Glance</h2>
        <div class="status45">

          <!-- Row 1: KPI tiles -->
          <div class="kpi-row">
            <!-- Trending Occupancy -->
            <div class="tile" id="kpi_trending_occ">
              <h3>Trending Occupancy</h3>
              <div class="big" data-kpi="trendingOcc">—</div>
              <div class="sub">
                Today <span data-kpi="todayOcc">—</span> • Target <span data-kpi="targetOcc">—</span>
                <span class="pill neutral">Occ + Preleased − On-Notice</span>
      </div>
      </div>

      

            <!-- Pacing to Target -->
            <div class="tile" id="kpi_pacing_gap">
              <h3>Pacing to Target</h3>
              <div class="big" data-kpi="gapPP">—</div>
              <div class="sub">Need <span data-kpi="homesNeeded">—</span> homes</div>
            </div>

            <!-- Undecided Renewals (30d) -->
            <div class="tile" id="kpi_undecided_30d" style="cursor:pointer">
              <h3>Undecided Renewals (30d)</h3>
              <div class="big"><span data-kpi="undecided30d">—</span></div>
              <div class="sub">of <span data-kpi="expiring30d">—</span> expiring</div>
            </div>

    setText(root,'#kpi_undecided_30d [data-kpi="undecided30d"]', String(s.undecided30d));
    setText(root,'#kpi_undecided_30d [data-kpi="expiring30d"]', String(s.expiring30d));
    var undecRate = (s.expiring30d>0) ? (s.undecided30d/s.expiring30d) : 0;
    classAs(document.getElementById('kpi_undecided_30d'), undecRate >= 0.40 ? 'red' : 'neutral');
    var undecTile = document.getElementById('kpi_undecided_30d');
    if (undecTile){
      undecTile.onclick = function(){ if (typeof showTab==='function') showTab('renewals'); };
    }

    // Step 73: Leasing Pacing tile removed

    var struggling = Array.isArray(s.strugglingFPs) ? s.strugglingFPs.filter(function(fp){
      return typeof fp.trendingOcc==='number' && fp.trendingOcc < s.targetOcc;
    }) : [];
    setText(root,'#alert_struggling_fps [data-kpi="strugglingCount"]', String(struggling.length));
    var listFP = root.querySelector('[data-list="fps"]');
    if(listFP){
      listFP.innerHTML = '';
      var top = struggling.slice(0,5);
      if(!top.length){
        var li = document.createElement('li'); li.className='alert-item';
        li.innerHTML = '<span>All clear</span><span><small>—</small></span>';
        listFP.appendChild(li);
      } else {
        top.forEach(function(fp){
          var gapPPv = (s.targetOcc - (fp.trendingOcc||0))*100;
          var need = (s.totalUnits>0 && gapPPv>0) ? Math.ceil(s.totalUnits*gapPPv/100) : 0;
          var li = document.createElement('li'); li.className='alert-item';
          li.innerHTML = `<span><strong>${fp.code||fp.floorplan||'—'}</strong> — ${((fp.trendingOcc||0)*100).toFixed(1)}% <small>(${gapPPv.toFixed(1)}%)</small></span><span><small>Need +${need} homes</small></span>`;
          li.style.cursor='pointer';
          li.onclick = function(){ if(typeof showTab==='function') showTab('newPricing'); };
          listFP.appendChild(li);
        });
      }
    }

    var stale = Array.isArray(s.staleUnits) ? s.staleUnits.slice(0,5) : [];
    setText(root,'#alert_stale_units [data-kpi="staleCount"]', String(Array.isArray(s.staleUnits)?s.staleUnits.length:0));
    var listStale = root.querySelector('[data-list="stale"]');
    if(listStale){
      listStale.innerHTML = '';
      if(!stale.length){
        var li2 = document.createElement('li'); li2.className='alert-item';
        li2.innerHTML = '<span>None</span><span><small>—</small></span>';
        listStale.appendChild(li2);
      } else {
        stale.forEach(function(u){
          var fp = u.fp || u.floorplan || '';
          var days = u.days || u.vacantDays || 0;
          var price = (typeof u.fpPrice==='number') ? u.fpPrice : (u.price || null);
          var right = (price!=null) ? (`<small>FP $${Math.round(price)}</small>`) : '<small></small>';
          var li3 = document.createElement('li'); li3.className='alert-item';
          li3.innerHTML = `<span><strong>${u.unit || u.UnitID || '—'}</strong> (${fp}) — ${days}d</span><span>${right}</span>`;
          li3.style.cursor='pointer';
          li3.onclick = function(){ if(typeof showTab==='function') showTab('newPricing'); };
          listStale.appendChild(li3);
        });
      }
    }
  }

  if (document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', paintStatus45);
  } else {
    setTimeout(paintStatus45, 0);
  }
  window.repaintStatus45 = paintStatus45;
})();
</script>

<script>
(function(){
  // Add signed percent formatter (e.g., +3.0%)
  function signedPctVal(x, d=1){ return (x>=0?'+':'') + (Number(x)||0).toFixed(d) + '%'; }
  window.__signedPctVal = signedPctVal; // optional global
})();
</script>

<script>
/* === Step 47: Box Score upload + mapper (pacing only) === */
(function(){
  console.log('BOX SCORE WIDGET LOADED (Step 47)');

  function parseCSV(text){
    const lines = text.split(/\r?\n/).filter(Boolean);
    if(!lines.length) return { header:[], rows:[] };
    const header = lines[0].split(',').map(h=>h.trim());
    const rows = lines.slice(1).map(line=>{
      const cells = line.split(',').map(c=>c.trim());
      const obj = {}; header.forEach((h,i)=> obj[h]=cells[i]); return obj;
    });
    return { header, rows };
  }
  function byId(id){ return document.getElementById(id); }
  function opt(parent, text){ const o=document.createElement('option'); o.value=text; o.textContent=text; parent.appendChild(o); }
  function toDate(s){ const d=new Date(s); return isNaN(d)?null:d; }
  function toNum(v){ const n=Number(v); return Number.isFinite(n)?n:0; }

  function computeBoxScoreMetrics(rows){
    const cfg = (typeof readCfg==='function') ? readCfg() : {};
    const windowDays = Math.max(7, Math.min(90, cfg.fs_windowDays ?? 28));
    const minLeads = Math.max(0, cfg.fs_minLeads ?? 50);
    const thrWeak = Math.max(0, Math.min(100, cfg.fs_thrWeak ?? 20));
    const thrCautious = Math.max(0, Math.min(100, cfg.fs_thrCautious ?? 30));

    const today = new Date(); today.setHours(0,0,0,0);
    const d7 = new Date(today); d7.setDate(d7.getDate()-6);
    const dW = new Date(today); dW.setDate(dW.getDate()-(windowDays-1));

    let approvals7d=0, leads7d=0, approvalsW=0, leadsW=0;
    for(const r of rows){
      const d = (function(s){ const dd=new Date(s); return isNaN(dd)?null:dd; })(r.__date);
      if(!d) continue;
      if (d >= d7 && d <= today){
        approvals7d += Number(r.__approvals)||0;
        leads7d     += Number(r.__leads)||0;
      }
      if (d >= dW && d <= today){
        approvalsW += Number(r.__approvals)||0;
        leadsW     += Number(r.__leads)||0;
      }
    }
    const convW = leadsW>0 ? (approvalsW/leadsW) : null; // 0..1 or null

    // Banding (display only)
    let band = null, bandClass = 'neutral', bandLabel = 'N/A';
    if (convW !== null && leadsW >= minLeads){
      const pct = convW*100;
      if (pct < thrWeak)        { band='Weak';     bandClass='red';   }
      else if (pct < thrCautious){ band='Cautious'; bandClass='amber'; }
      else if (pct < 40)        { band='Watch';    bandClass='amber'; }
      else                      { band='Healthy';  bandClass='green'; }
      bandLabel = `${band} (${pct.toFixed(0)}%, n=${leadsW}, ${windowDays}d)`;
    } else if (convW !== null) {
      bandLabel = `N/A (n=${leadsW}<${minLeads}, ${windowDays}d)`;
    }

    const M = (band==='Weak') ? (cfg.fs_mulWeak ?? 0.2) : (band==='Cautious') ? (cfg.fs_mulCautious ?? 0.5) : (band==='Watch') ? (cfg.fs_mulWatch ?? 0.8) : (band==='Healthy') ? (cfg.fs_mulHealthy ?? 1.0) : 1.0;

    return {
      approvals7d, leads7d,
      approvals28: approvalsW, leads28: leadsW, conv28: convW,
      band, bandClass, bandLabel,
      windowDays, minLeads,
      multiplier: M
    };
  }

  function feedStatusWidgetFromBox(rows){
  // Step 72: funnel removed — no-op to avoid influencing any state
  return;
}

  function initBoxUploader(){
    const fileInput = byId('boxscoreFile');
    const btnParse = byId('btnParseBoxScore');
    const meta = byId('boxscoreMeta');
    const mapWrap = byId('boxscoreMap');
    const sDate = byId('map_bs_date');
    const sLeads = byId('map_bs_leads');
    const sApps = byId('map_bs_apps');
    const sAppr = byId('map_bs_approvals');
    const btnConfirm = byId('btnConfirmBoxScore');
    if (!fileInput || !btnParse || !meta || !mapWrap) return;

    let parsed = null;
    btnParse.onclick = async function(){
      const f = fileInput.files && fileInput.files[0];
      if(!f){ meta.textContent = 'No file selected'; return; }
      const text = await f.text();
      parsed = parseCSV(text);
      if (!parsed.header.length){ meta.textContent = 'Could not parse CSV'; return; }
      [sDate,sLeads,sApps,sAppr].forEach(sel => { sel.innerHTML=''; parsed.header.forEach(h=>opt(sel,h)); });
      function guess(cols, kws){ const lc=cols.map(c=>c.toLowerCase()); for(const k of kws){ const i=lc.findIndex(x=>x.includes(k)); if(i>=0) return cols[i]; } return cols[0]; }
      sDate.value  = guess(parsed.header, ['date','day']);
      sLeads.value = guess(parsed.header, ['lead','traffic','tour']);
      sApps.value  = guess(parsed.header, ['app']);
      sAppr.value  = guess(parsed.header, ['approval','approved']);
      meta.textContent = `Parsed ${parsed.rows.length} rows`;
      mapWrap.style.display = 'block';
    };

    if (btnConfirm){
      btnConfirm.onclick = function(){
        if(!parsed){ meta.textContent='Parse a file first'; return; }
        const mapped = parsed.rows.map(r => ({ __date: r[sDate.value], __leads: r[sLeads.value], __apps: r[sApps.value], __approvals: r[sAppr.value] })).filter(r => r.__date);
        window.boxScoreRows = mapped;
        meta.textContent = `Mapped ${mapped.length} rows • ready`;
        mapWrap.style.display = 'none';
        feedStatusWidgetFromBox(mapped);
      };
    }
  }

  if (document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', initBoxUploader);
  } else {
    initBoxUploader();
  }
})();
</script>

<script>
/* Step 51: funnel lever (preview) settings bind */
(function(){
  if (typeof readCfg!=='function' || typeof writeCfg!=='function') return;
  var cfg = readCfg();

  // Defaults (preview only)
  if (cfg.fs_mulWeak     == null) cfg.fs_mulWeak     = 0.2; // heavy dampen
  if (cfg.fs_mulCautious == null) cfg.fs_mulCautious = 0.5; // cautious
  if (cfg.fs_mulWatch    == null) cfg.fs_mulWatch    = 0.8; // mild dampen
  if (cfg.fs_mulHealthy  == null) cfg.fs_mulHealthy  = 1.0; // normal
  if (cfg.fs_useLever    == null) cfg.fs_useLever    = false; // OFF by default

  writeCfg(cfg);

  function $(id){ return document.getElementById(id); }
  var w=$('fs_mulWeak'), c=$('fs_mulCautious'), a=$('fs_mulWatch'), h=$('fs_mulHealthy'), t=$('fs_useLever');
  if (!w||!c||!a||!h||!t) return;

  w.value = cfg.fs_mulWeak;
  c.value = cfg.fs_mulCautious;
  a.value = cfg.fs_mulWatch;
  h.value = cfg.fs_mulHealthy;
  t.checked = !!cfg.fs_useLever;

  function save(){
    var cfg2 = readCfg();
    cfg2.fs_mulWeak     = Math.max(0, Math.min(2, +w.value || 0.2));
    cfg2.fs_mulCautious = Math.max(0, Math.min(2, +c.value || 0.5));
    cfg2.fs_mulWatch    = Math.max(0, Math.min(2, +a.value || 0.8));
    cfg2.fs_mulHealthy  = Math.max(0, Math.min(2, +h.value || 1.0));
    cfg2.fs_useLever    = !!t.checked; // not applied yet
    writeCfg(cfg2);

    // Refresh Status widget preview if box score present
    if (Array.isArray(window.boxScoreRows) && typeof feedStatusWidgetFromBox==='function'){
      try { feedStatusWidgetFromBox(window.boxScoreRows); } catch(e){}
    }
  }

  [w,c,a,h].forEach(el=>el.addEventListener('change', save));
  t.addEventListener('change', save);
})();
</script>

<script>
// Step 49: Settings bindings for funnel band (display only)
(function(){
  function el(id){ return document.getElementById(id); }
  if (el('fs_windowDays')){
    const cfg = readCfg();
    // Step 49 defaults if missing
    if (cfg.fs_windowDays == null) cfg.fs_windowDays = 28;
    if (cfg.fs_minLeads   == null) cfg.fs_minLeads   = 50;
    if (cfg.fs_thrWeak    == null) cfg.fs_thrWeak    = 20;
    if (cfg.fs_thrCautious== null) cfg.fs_thrCautious= 30;

    el('fs_windowDays').value  = cfg.fs_windowDays;
    el('fs_minLeads').value    = cfg.fs_minLeads;
    el('fs_thrWeak').value     = cfg.fs_thrWeak;
    el('fs_thrCautious').value = cfg.fs_thrCautious;

    ['fs_windowDays','fs_minLeads','fs_thrWeak','fs_thrCautious'].forEach(id=>{
      el(id).addEventListener('change', ()=>{
        const c = readCfg();
        c.fs_windowDays  = Math.max(7, Math.min(90, +el('fs_windowDays').value||28));
        c.fs_minLeads    = Math.max(0, +el('fs_minLeads').value||50);
        c.fs_thrWeak     = Math.max(0, Math.min(100, +el('fs_thrWeak').value||20));
        c.fs_thrCautious = Math.max(0, Math.min(100, +el('fs_thrCautious').value||30));
        writeCfg(c);
        if (Array.isArray(window.boxScoreRows) && typeof feedStatusWidgetFromBox==='function'){
          try { feedStatusWidgetFromBox(window.boxScoreRows); } catch(e){}
        }
      });
    });
  }
})();
</script>

<script>
// Step 48: If a Box Score was uploaded earlier in the session, re-feed the widget on load
(function(){
  if (Array.isArray(window.boxScoreRows)) {
    try { if (typeof feedStatusWidgetFromBox==='function') feedStatusWidgetFromBox(window.boxScoreRows); } catch(e){}
  }
})();
</script>
</body>
</html>
